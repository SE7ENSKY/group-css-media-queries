#!/usr/bin/env node

var fs        = require('fs'),
    path      = require('path'),
    main      = require(path.join(path.dirname(fs.realpathSync(__filename)), '../')),
    argv      = require('optimist').argv,
    slugify   = require('slugify'),
    stringify = require('css-stringify'),
    colors    = require('colors'),
    mkdirp    = require('mkdirp');

// Help message
var help = 
 "Usage:\n"
+"  group-css-media-queries [options] [input_file] [output_file]\n\n"
+"Options:\n"
+"  -s, --split    split output in pultiple files\n"
+"  -d, --dir      output files to this directory\n"
+"  -h, --help     display this message"
;

// Display help ?
if ( argv.h || argv.help ) {
    console.log(help);
    process.exit(0);
}

// No input file provided ?
if ( !argv.s && !argv.split && !argv._.length ) {
    console.log("Error: no input file provided")
    console.log(help);
    process.exit(-1);
}

var input = function(cb) {
    var inputFilename = argv.s || argv.split || argv._[0];
    if (inputFilename) {
        cb(fs.readFileSync(inputFilename, "utf8"));
    } else {
        var data = "";
        process.stdin.resume();
        process.stdin.setEncoding('utf8');

        process.stdin.on('data', function(chunk) {
            data += chunk;
        });

        process.stdin.on('end', function() {
            cb(data);
        });
    }
};

var output = function(data) {
    
    // Split result
    if (argv.s || argv.split){
        var inputFilename = argv.s || argv.split || argv._[0];
        var outputBaseName = path.basename(inputFilename).replace(path.extname(inputFilename), "");
        var outputDir = argv.d || argv.dir || (outputBaseName + "-splitted");

        // Create output dir
        mkdirp(outputDir, function (err) {
            if (err){
                console.error(err)
                process.exit(-1);
            }

            var outputName, rules, sheet;

            // Loop on each media group rules.
            // [0] => root rules
            for(var i=0; i<data.length; i++){
                // Root rules
                if (i == 0){
                    outputName = outputBaseName + "-root.css";
                    rules = data[i];
                }
                // Other media rules
                else{
                    outputName = data[i].media.replace(/:\s+/g, "-");
                    outputName = outputBaseName + "-" + slugify(outputName) + ".css";
                    rules = [data[i]];
                }
                outputName = outputDir + '/' + outputName;

                console.log ("Creating " + outputName.green);
                sheet = {
                    type: 'stylesheet',
                    stylesheet: {
                        rules: rules
                    }
                }
                // Write css file
                fs.writeFileSync(outputName, stringify(sheet));
            }
        });
    }
    // Or in a single file (or direct output) 
    else{
        var outputFilename = argv._[1];
        if (outputFilename) {
            fs.writeFileSync(outputFilename, data);
        } else {
            console.log(data);
        }

    }
};

// Do the work
input(function(data) {
    result = main(data, argv.s || argv.split);
    output(result);
});
